<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>flag{titl3_1s_zsy_arch}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="flag{titl3_1s_zsy_arch}">
<meta property="og:url" content="https://zsy-arch.github.io/index.html">
<meta property="og:site_name" content="flag{titl3_1s_zsy_arch}">
<meta property="og:locale">
<meta property="article:author" content="zsy">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="flag{titl3_1s_zsy_arch}" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">flag{titl3_1s_zsy_arch}</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://zsy-arch.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-tasteless-ctf-2021-rev-PVM" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/05/tasteless-ctf-2021-rev-PVM/" class="article-date">
  <time class="dt-published" datetime="2021-10-05T13:42:48.000Z" itemprop="datePublished">2021-10-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/05/tasteless-ctf-2021-rev-PVM/">tasteless_ctf_2021 [rev] PVM</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="PVM"><a href="#PVM" class="headerlink" title="PVM"></a>PVM</h3><p>看到题目名字里的“VM”就想到了虚拟机，根据题目描述里的“Pico SDK” “ARM” 以及附件里的图片，猜测应该是一个运行在树莓派开发板的程序。</p>
<h4 id="使用r2"><a href="#使用r2" class="headerlink" title="使用r2"></a>使用r2</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r2 -a arm -b 16 -m 0x8000000 chall.bin</span><br></pre></td></tr></table></figure>

<h4 id="寻找关键函数"><a href="#寻找关键函数" class="headerlink" title="寻找关键函数"></a>寻找关键函数</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pdf @xxx</span><br></pre></td></tr></table></figure>

<p>这里的xxx表示还没有找到 = =，待续。。。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://zsy-arch.github.io/2021/10/05/tasteless-ctf-2021-rev-PVM/" data-id="ckue4zfkf0000y4v492uge427" data-title="tasteless_ctf_2021 [rev] PVM" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-编译原理学习笔记" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T14:36:09.000Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">编译原理学习笔记</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="词法分析"><a href="#词法分析" class="headerlink" title="词法分析"></a>词法分析</h2><p>词法分析一般是编译的第一个阶段。一个编程语言代码，主要包含以下元素：（1）关键字，可能包括if、for、void、class等；（2）字面量，如实数、字符串等；（3）符号：小括号、大括号、加号、减号等；（4）标识符，也就是变量名、函数名、类名等。</p>
<p>词法分析器以空格符、换行符为分割，利用正则表达式找出每个元素所属的类型。根据元素类型创建一个Token。</p>
<h3 id="NFA、DFA"><a href="#NFA、DFA" class="headerlink" title="NFA、DFA"></a>NFA、DFA</h3><p>有多少种元素类型，就要设置多少正则表达式，为检测出正确Token类型，需要与每一个正则表达式匹配，非常不便。所以出现了NFA、DFA，它们本质上是数据结构——图。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://zsy-arch.github.io/2021/10/01/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-id="ckue4zfkk0001y4v46ctg74cq" data-title="编译原理学习笔记" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-CSAPP-1-原码、反码、补码、IEEE-754" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/CSAPP-1-%E5%8E%9F%E7%A0%81%E3%80%81%E5%8F%8D%E7%A0%81%E3%80%81%E8%A1%A5%E7%A0%81%E3%80%81IEEE-754/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T14:03:02.000Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/CSAPP-1-%E5%8E%9F%E7%A0%81%E3%80%81%E5%8F%8D%E7%A0%81%E3%80%81%E8%A1%A5%E7%A0%81%E3%80%81IEEE-754/">CSAPP 1 - 原码、反码、补码、IEEE 754 实战</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="求任意数x的补码"><a href="#求任意数x的补码" class="headerlink" title="求任意数x的补码"></a>求任意数x的补码</h2><ol>
<li>求x绝对值abs(x)的原码为Bin_1，比如 <code>0001 0100</code></li>
<li>如果，x本身为非负数，则x的补码即为Bin_1。否则进入下一步。</li>
<li>从右向左开始，找到第一个为1的二进制位，此二进制位<strong>左侧</strong>且<strong>不包括</strong>它的取反码为Bin_2。</li>
</ol>
<p>此例中，Bin_2 = 1110 1100</p>
<h2 id="求浮点数y的IEEE-754格式"><a href="#求浮点数y的IEEE-754格式" class="headerlink" title="求浮点数y的IEEE 754格式"></a>求浮点数y的IEEE 754格式</h2><ol>
<li>求y的绝对值abs(y)，将abs(y)的<strong>整数部分</strong>通过<strong>除二取余法</strong>得到原码为Bin_1，<strong>小数部分</strong>通过<strong>乘二取整法</strong>得到原码为Bin_2；则abs(y)的二进制表示为Bin_1.Bin_2。</li>
<li>向左或向右移动小数点E位，使得正数部分为单独一个二进制位 1，即：Bin_1.Bin_2 = 1.Bin_3 的 E 次方。记M = Bin_3。</li>
<li>根据 E = exp - Bias，得到exp的值。32位（float类型）IEEE 754中，Bias = 127，64位（double类型）中Bias = 1023。</li>
<li>若y为正数，则记二进制位s等于0，否则等于1。</li>
<li>则浮点数y的IEEE 754格式为：s | exp | M，其中|为分隔符，实际编写中不需要。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://zsy-arch.github.io/2021/10/01/CSAPP-1-%E5%8E%9F%E7%A0%81%E3%80%81%E5%8F%8D%E7%A0%81%E3%80%81%E8%A1%A5%E7%A0%81%E3%80%81IEEE-754/" data-id="cku8gvn310001tkv4hokm8qp1" data-title="CSAPP 1 - 原码、反码、补码、IEEE 754 实战" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Cross-compile-and-QEMU" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/09/30/Cross-compile-and-QEMU/" class="article-date">
  <time class="dt-published" datetime="2021-09-30T11:57:06.000Z" itemprop="datePublished">2021-09-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/09/30/Cross-compile-and-QEMU/">Cross compile and QEMU</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="MIPS"><a href="#MIPS" class="headerlink" title="MIPS"></a>MIPS</h1><h2 id="On-Linux"><a href="#On-Linux" class="headerlink" title="On Linux"></a>On Linux</h2><h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h3><p><code>$ sudo apt install gcc-10-mips-linux-gnu</code></p>
<h3 id="2-编译Hello-World！"><a href="#2-编译Hello-World！" class="headerlink" title="2. 编译Hello World！"></a>2. 编译Hello World！</h3><p><code>$ </code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://zsy-arch.github.io/2021/09/30/Cross-compile-and-QEMU/" data-id="cku8gvn320002tkv43n1c82bx" data-title="Cross compile and QEMU" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-C-argument-dependent-name-lookup" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/08/28/C-argument-dependent-name-lookup/" class="article-date">
  <time class="dt-published" datetime="2021-08-28T06:55:15.000Z" itemprop="datePublished">2021-08-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/08/28/C-argument-dependent-name-lookup/">C++ argument-dependent name lookup</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>概念：函数中参数的命名空间会添加到函数搜索列表中。</p>
<p>示例：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> X &#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">C</span> &#123;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(C c)</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;X::foo&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    X::C c;</span><br><span class="line">    <span class="built_in">foo</span>(c);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zsy-arch.github.io/2021/08/28/C-argument-dependent-name-lookup/" data-id="cku8gvn330003tkv43jxtc3z0" data-title="C++ argument-dependent name lookup" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-祥云杯2021复盘" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/08/28/%E7%A5%A5%E4%BA%91%E6%9D%AF2021%E5%A4%8D%E7%9B%98/" class="article-date">
  <time class="dt-published" datetime="2021-08-28T05:16:27.000Z" itemprop="datePublished">2021-08-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/08/28/%E7%A5%A5%E4%BA%91%E6%9D%AF2021%E5%A4%8D%E7%9B%98/">祥云杯2021复盘</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="re-Dizzy"><a href="#re-Dizzy" class="headerlink" title="re_Dizzy"></a>re_Dizzy</h2><ol>
<li>反汇编出main函数，导出汇编文件(.asm)</li>
<li>利用正则表达式将所有加密功能的汇编代表转换为python语法表示</li>
<li>使用脚本计算flag</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./Dizzy.exe.asm&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    lines = f.readlines()</span><br><span class="line"></span><br><span class="line">lines.reverse()</span><br><span class="line"></span><br><span class="line">flag = [<span class="number">0x27</span> ,<span class="number">0x3C</span> ,<span class="number">0x0E3</span>,<span class="number">0x0FC</span>,<span class="number">0x2E</span> ,<span class="number">0x41</span> ,<span class="number">7</span>,<span class="number">0x5E</span> ,<span class="number">0x62</span> ,<span class="number">0x0CF</span>,<span class="number">0x0E8</span>,<span class="number">0x0F2</span>,<span class="number">0x92</span>,<span class="number">0x80</span>,<span class="number">0x0E2</span>,<span class="number">0x36</span> ,<span class="number">0x0B4</span>,<span class="number">0x0B2</span>,<span class="number">0x67</span> ,<span class="number">0x77</span> ,<span class="number">0x0F</span>,<span class="number">0x0F6</span>,<span class="number">0x0D</span>,<span class="number">0x0B6</span>,<span class="number">0x0ED</span>,<span class="number">0x1C</span>,<span class="number">0x65</span> ,<span class="number">0x8A</span>,<span class="number">7</span>,<span class="number">0x53</span> ,<span class="number">0x0A6</span>,<span class="number">0x66</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;-&#x27;</span> <span class="keyword">in</span> line:</span><br><span class="line">        tmp = line.replace(<span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">        <span class="built_in">exec</span>(tmp)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&#x27;+&#x27;</span> <span class="keyword">in</span> line:</span><br><span class="line">        tmp = line.replace(<span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">        <span class="built_in">exec</span>(tmp)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">exec</span>(line)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> flag:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(f &amp; <span class="number">0xff</span>), end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="re-勒索解密"><a href="#re-勒索解密" class="headerlink" title="re_勒索解密"></a>re_勒索解密</h2><ol>
<li>编译、运行以下C++程序</li>
<li>在生成的bmp文件中寻找0x424d开头的文件</li>
<li>打开图片</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;wincrypt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;advapi32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AES_KEY_SIZE 16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CHUNK_SIZE (0xD6850) <span class="comment">// an output buffer must be a multiple of the key size</span></span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">size_t</span> sizeChunk = CHUNK_SIZE;</span><br><span class="line">BYTE bsChunk[sizeChunk] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (x &lt; <span class="number">65536</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		DWORD dwStatus = <span class="number">0</span>;</span><br><span class="line">		BOOL bResult = FALSE;</span><br><span class="line">		<span class="keyword">char</span> info[] = <span class="string">&quot;Microsoft Enhanced RSA and AES Cryptographic Provider&quot;</span>;</span><br><span class="line">		HCRYPTPROV hProv;</span><br><span class="line">		<span class="keyword">char</span> key_str[] = <span class="string">&quot;\xB2\x2F\xC6\x0E\x4F\xD4\x54\x4B\x6c\x81\x1a\x61\x21\xE7\xB1\x8E&quot;</span>;</span><br><span class="line">		key_str[<span class="number">8</span>] = *((BYTE*)&amp;x);</span><br><span class="line">		key_str[<span class="number">9</span>] = *(((BYTE*)&amp;x) + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">CryptAcquireContextA</span>(&amp;hProv, <span class="literal">NULL</span>, info, <span class="number">0x18</span>u, <span class="number">0xF0000000</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			dwStatus = <span class="built_in">GetLastError</span>();</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;CryptAcquireContext failed: %x\n&quot;</span>, dwStatus);</span><br><span class="line">			<span class="built_in">CryptReleaseContext</span>(hProv, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">return</span> dwStatus;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		HCRYPTHASH hHash;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">CryptCreateHash</span>(hProv, <span class="number">0x800C</span>u, <span class="number">0</span>, <span class="number">0</span>, &amp;hHash)) &#123;</span><br><span class="line">			dwStatus = <span class="built_in">GetLastError</span>();</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;CryptCreateHash failed: %x\n&quot;</span>, dwStatus);</span><br><span class="line">			<span class="built_in">CryptReleaseContext</span>(hProv, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">return</span> dwStatus;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">CryptHashData</span>(hHash, (BYTE*)key_str, <span class="number">16</span>, <span class="number">0</span>)) &#123;</span><br><span class="line">			DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;CryptHashData Failed : %#x\n&quot;</span>, err);</span><br><span class="line">			<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> (<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		HCRYPTKEY hKey;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">CryptDeriveKey</span>(hProv, <span class="number">0x660E</span>u, hHash, <span class="number">0</span>, &amp;hKey)) &#123;</span><br><span class="line">			dwStatus = <span class="built_in">GetLastError</span>();</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;CryptDeriveKey failed: %x\n&quot;</span>, dwStatus);</span><br><span class="line">			<span class="built_in">CryptReleaseContext</span>(hProv, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">return</span> dwStatus;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		BOOL bIsFinal = FALSE;</span><br><span class="line">		LPCWSTR lpwszInputFile = <span class="string">L&quot;D:\\CTF\\祥云杯2021\\勒索解密_a6b0af561d5ad1ff25888265806a1be3\\flag.bmp.ctf_crypter&quot;</span>;</span><br><span class="line">		<span class="keyword">wchar_t</span> lpwszOut[MAX_PATH];</span><br><span class="line"></span><br><span class="line">		<span class="built_in">swprintf_s</span>(lpwszOut, MAX_PATH, <span class="string">L&quot;D:\\CTF\\祥云杯2021\\勒索解密_a6b0af561d5ad1ff25888265806a1be3\\flag-%d.bmp&quot;</span>);</span><br><span class="line">		LPCWSTR lpwszOutputFile = lpwszOut;</span><br><span class="line">		HANDLE hInputFile = <span class="built_in">CreateFileW</span>(lpwszInputFile, GENERIC_READ, FILE_SHARE_READ, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_FLAG_SEQUENTIAL_SCAN, <span class="literal">NULL</span>);</span><br><span class="line">		HANDLE hOutputFile = <span class="built_in">CreateFileW</span>(lpwszOutputFile, GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (hInputFile == <span class="literal">NULL</span> || hOutputFile == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			dwStatus = <span class="built_in">GetLastError</span>();</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;CreateFileW failed: %x\n&quot;</span>, dwStatus);</span><br><span class="line">			<span class="built_in">CryptReleaseContext</span>(hProv, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">return</span> dwStatus;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		DWORD dwInputFileSize = <span class="built_in">GetFileSize</span>(hInputFile, <span class="literal">NULL</span>);</span><br><span class="line">		DWORD dwTotalReadFileSize = <span class="number">0</span>;</span><br><span class="line">		DWORD dwReadFileLen = <span class="number">0</span>;</span><br><span class="line">		BYTE* pbOutBytes = (BYTE*)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(BYTE) * dwInputFileSize);</span><br><span class="line">		<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		BYTE dwData[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">		*((DWORD*)dwData) = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">CryptSetKeyParam</span>(hKey, KP_PADDING, (BYTE*)&amp;dwData, <span class="number">0</span>);</span><br><span class="line">		<span class="built_in">CryptSetKeyParam</span>(hKey, KP_MODE, (BYTE*)&amp;dwData, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (bResult = <span class="built_in">ReadFile</span>(hInputFile, bsChunk, sizeChunk, &amp;dwReadFileLen, <span class="literal">NULL</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (dwReadFileLen == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (dwReadFileLen &lt; sizeChunk)</span><br><span class="line">			&#123;</span><br><span class="line">				bIsFinal = TRUE;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;i=%d, read=%d, total_read=%d, is_final=%d\n&quot;</span>, i, dwReadFileLen, dwTotalReadFileSize, bIsFinal);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!<span class="built_in">CryptDecrypt</span>(hKey, <span class="literal">NULL</span>, bIsFinal, <span class="number">0</span>, bsChunk, &amp;dwReadFileLen))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;[-] CryptDecrypt failed %x\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			DWORD written = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span> (!<span class="built_in">WriteFile</span>(hOutputFile, bsChunk, dwReadFileLen, &amp;written, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;writing failed!\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="built_in">memset</span>(bsChunk, <span class="number">0</span>, sizeChunk);</span><br><span class="line">			i++;</span><br><span class="line">		&#125;</span><br><span class="line">		x++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zsy-arch.github.io/2021/08/28/%E7%A5%A5%E4%BA%91%E6%9D%AF2021%E5%A4%8D%E7%9B%98/" data-id="cku8gvn3i000itkv4eu2qfry1" data-title="祥云杯2021复盘" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-corCTF2021-复盘" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/08/28/corCTF2021-%E5%A4%8D%E7%9B%98/" class="article-date">
  <time class="dt-published" datetime="2021-08-28T04:42:54.000Z" itemprop="datePublished">2021-08-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/08/28/corCTF2021-%E5%A4%8D%E7%9B%98/">corCTF2021 复盘</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="babyrev"><a href="#babyrev" class="headerlink" title="babyrev"></a>babyrev</h2><ol>
<li>memfrob函数：将字符串的每个字符与42进行异或实现加密。</li>
</ol>
<p>解密脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_prime</span>(<span class="params">n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bool</span>:</span></span><br><span class="line">    <span class="keyword">if</span> n &lt;= <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    i = <span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> i &lt;= n // <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">if</span> n % i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rot_n</span>(<span class="params">c, n</span>):</span></span><br><span class="line">    ASCII_UPPER = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span></span><br><span class="line">    ASCII_LOWER = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">in</span> ASCII_UPPER:</span><br><span class="line">        <span class="keyword">return</span> ASCII_UPPER[(ASCII_UPPER.index(c) + n) % <span class="number">26</span>]</span><br><span class="line">    <span class="keyword">elif</span> c <span class="keyword">in</span> ASCII_LOWER:</span><br><span class="line">        <span class="keyword">return</span> ASCII_LOWER[(ASCII_LOWER.index(c) + n) % <span class="number">26</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">check = [<span class="number">0x5f</span>, <span class="number">0x40</span>, <span class="number">0x5a</span>, <span class="number">0x15</span>, <span class="number">0x75</span>, <span class="number">0x45</span>, <span class="number">0x62</span>, <span class="number">0x53</span>, <span class="number">0x75</span>, <span class="number">0x46</span>, <span class="number">0x52</span>, <span class="number">0x43</span>, <span class="number">0x5f</span>, <span class="number">0x75</span>, <span class="number">0x50</span>, <span class="number">0x52</span>, <span class="number">0x75</span>, <span class="number">0x5f</span>,</span><br><span class="line">         <span class="number">0x5c</span>, <span class="number">0x4f</span>]</span><br><span class="line"><span class="comment"># memfrob</span></span><br><span class="line">check = [c ^ <span class="number">42</span> <span class="keyword">for</span> c <span class="keyword">in</span> check]</span><br><span class="line">flag = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(check)):</span><br><span class="line">    p = <span class="number">4</span> * i</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> is_prime(p):</span><br><span class="line">        p += <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(rot_n(<span class="built_in">chr</span>(check[i]), -p), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://zsy-arch.github.io/2021/08/28/corCTF2021-%E5%A4%8D%E7%9B%98/" data-id="cku8gvn3a000ctkv4do4ohrg6" data-title="corCTF2021 复盘" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Golang-deferred函数" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/08/20/Golang-deferred%E5%87%BD%E6%95%B0/" class="article-date">
  <time class="dt-published" datetime="2021-08-20T15:28:57.000Z" itemprop="datePublished">2021-08-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/08/20/Golang-deferred%E5%87%BD%E6%95%B0/">Golang deferred函数</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="deferred函数调用"><a href="#deferred函数调用" class="headerlink" title="deferred函数调用"></a>deferred函数调用</h2><p>在大多数编程语言中，一个函数结束后便会返回到调用者的代码处，但是Go语言提供了一个关键词<strong>deferred</strong>，可以实现函数返回后先执行<code>deferred</code>指定的一个或几个函数，当这些deferred函数全部执行完毕后，再回到调用者的代码处。</p>
<h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">foo</span><span class="params">(a <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> fmt.Println(<span class="string">&quot;defer1&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;a &gt;= 0&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> a</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;a &lt; 0&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> -a</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://zsy-arch.github.io/2021/08/20/Golang-deferred%E5%87%BD%E6%95%B0/" data-id="cku8gvn340004tkv43bjsc7h2" data-title="Golang deferred函数" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-just-inject-第一天-CreateRemoteThreadInject" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/08/19/just-inject-%E7%AC%AC%E4%B8%80%E5%A4%A9-CreateRemoteThreadInject/" class="article-date">
  <time class="dt-published" datetime="2021-08-19T12:58:42.000Z" itemprop="datePublished">2021-08-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/08/19/just-inject-%E7%AC%AC%E4%B8%80%E5%A4%A9-CreateRemoteThreadInject/">just_inject 第一天: CreateRemoteThreadInject</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="代码总览"><a href="#代码总览" class="headerlink" title="代码总览"></a>代码总览</h2><p>(just_inject.cpp)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _JUST_INJECT_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _JUST_INJECT_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;wchar.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">SetPrivilege</span><span class="params">(HANDLE, LPCWSTR, BOOL)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">SetDebugPrivilege</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">RemoteThreadInject</span><span class="params">(DWORD, DWORD)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">RemoteThreadInject</span><span class="params">(DWORD, LPCWSTR)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">SetDebugPrivilege</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE hToken;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">OpenProcessToken</span>(</span><br><span class="line">		<span class="built_in">GetCurrentProcess</span>(),</span><br><span class="line">		TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY,</span><br><span class="line">		&amp;hToken</span><br><span class="line">	);</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">SetPrivilege</span>(hToken, SE_DEBUG_NAME, TRUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">SetPrivilege</span><span class="params">(HANDLE hToken, LPCWSTR lpszPrivilege, BOOL bEnablePrivilege)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LUID luid;</span><br><span class="line">	TOKEN_PRIVILEGES tp;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">LookupPrivilegeValueW</span>(<span class="literal">NULL</span>, lpszPrivilege, &amp;luid))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf_s</span>(<span class="string">L&quot;LookupPrivilegeValueW failed %u\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tp.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">	tp.Privileges[<span class="number">0</span>].Luid = luid;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bEnablePrivilege)</span><br><span class="line">	&#123;</span><br><span class="line">		tp.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		tp.Privileges[<span class="number">0</span>].Attributes = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">AdjustTokenPrivileges</span>(</span><br><span class="line">		hToken,</span><br><span class="line">		FALSE,</span><br><span class="line">		&amp;tp,</span><br><span class="line">		<span class="built_in"><span class="keyword">sizeof</span></span>(tp),</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		<span class="literal">NULL</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf_s</span>(<span class="string">L&quot;AdjustTokenPrivileges failed %u\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">RemoteThreadInject</span><span class="params">(DWORD dwTargetProcessId, DWORD dwFuncAddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">SetDebugPrivilege</span>();</span><br><span class="line"></span><br><span class="line">	HANDLE hTargetProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, dwTargetProcessId);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hTargetProcess == <span class="literal">NULL</span> || hTargetProcess == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf_s</span>(<span class="string">L&quot;OpenProcess failed.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	DWORD dwThreadId = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	HANDLE hRemoteThread = <span class="built_in">CreateRemoteThread</span>(hTargetProcess,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		(LPTHREAD_START_ROUTINE)dwFuncAddr,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		&amp;dwThreadId);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hRemoteThread == <span class="literal">NULL</span> || hRemoteThread == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf_s</span>(<span class="string">L&quot;CreateRemoteThread failed.\n&quot;</span>);</span><br><span class="line">		<span class="built_in">CloseHandle</span>(hTargetProcess);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">WaitForSingleObject</span>(hRemoteThread, INFINITE);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hRemoteThread);</span><br><span class="line">	hRemoteThread = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">RemoteThreadInject</span><span class="params">(DWORD dwTargetProcessId, LPCWSTR lpszDllPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">SetDebugPrivilege</span>();</span><br><span class="line"></span><br><span class="line">	HANDLE hTargetProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, dwTargetProcessId);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hTargetProcess == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf_s</span>(<span class="string">L&quot;OpenProcess failed.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ULONG32 ulDllPathLen = <span class="built_in">wcsnlen_s</span>(lpszDllPath, MAX_PATH);</span><br><span class="line">	LPVOID lpvVaDllPath = <span class="built_in">VirtualAllocEx</span>(hTargetProcess, <span class="literal">NULL</span>, ulDllPathLen * <span class="built_in"><span class="keyword">sizeof</span></span>(WCHAR) + <span class="number">16</span>, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (lpvVaDllPath == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf_s</span>(<span class="string">L&quot;VirtualAllocEx failed.\n&quot;</span>);</span><br><span class="line">		<span class="built_in">CloseHandle</span>(hTargetProcess);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">WriteProcessMemory</span>(hTargetProcess, lpvVaDllPath, (LPCVOID)lpszDllPath, ulDllPathLen * <span class="built_in"><span class="keyword">sizeof</span></span>(WCHAR) + <span class="number">16</span>, <span class="literal">NULL</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf_s</span>(<span class="string">L&quot;WriteProcessMemory failed.\n&quot;</span>);</span><br><span class="line">		<span class="built_in">VirtualFreeEx</span>(hTargetProcess, lpvVaDllPath, ulDllPathLen * <span class="built_in"><span class="keyword">sizeof</span></span>(WCHAR) + <span class="number">16</span>, MEM_RELEASE);</span><br><span class="line">		<span class="built_in">CloseHandle</span>(hTargetProcess);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	LPTHREAD_START_ROUTINE lptsrLoadLibraryW = (LPTHREAD_START_ROUTINE)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleW</span>(<span class="string">L&quot;kernel32&quot;</span>), <span class="string">&quot;LoadLibraryW&quot;</span>);</span><br><span class="line">	DWORD dwThreadId = <span class="number">0</span>;</span><br><span class="line">	HANDLE hThread = <span class="built_in">CreateRemoteThread</span>(hTargetProcess, <span class="literal">NULL</span>, <span class="number">0</span>, lptsrLoadLibraryW, lpvVaDllPath, <span class="number">0</span>, &amp;dwThreadId);</span><br><span class="line">	<span class="keyword">if</span> (hThread == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf_s</span>(<span class="string">L&quot;CreateRemoteThread failed.\n&quot;</span>);</span><br><span class="line">		<span class="built_in">VirtualFreeEx</span>(hTargetProcess, lpvVaDllPath, ulDllPathLen * <span class="built_in"><span class="keyword">sizeof</span></span>(WCHAR) + <span class="number">16</span>, MEM_RELEASE);</span><br><span class="line">		<span class="built_in">CloseHandle</span>(hTargetProcess);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf_s</span>(<span class="string">L&quot;CreateRemoteThread 0x%x.\n&quot;</span>, dwThreadId);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">WaitForSingleObject</span>(hThread, INFINITE);</span><br><span class="line">	<span class="built_in">VirtualFreeEx</span>(hTargetProcess, lpvVaDllPath, ulDllPathLen * <span class="built_in"><span class="keyword">sizeof</span></span>(WCHAR) + <span class="number">16</span>, MEM_RELEASE);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hTargetProcess);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h2 id="代码解释"><a href="#代码解释" class="headerlink" title="代码解释"></a>代码解释</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>众所周知在现代操作系统（Windows、Linux、MAC）中，每个进程是相对独立的，一个进程的资源分配和运行直接由操作系统处理。操作系统将内存空间分为用户空间与内核空间，其中，操作系统及驱动程序运行在内核空间，拥有较高权限，甚至对硬件都有极大影响，用户空间则用来给普通进程使用，拥有较低的权限，只能使用一些操作系统、驱动开放的接口来实现功能（一般EXE、DLL类程序运行在用户空间，SYS类程序运行在内核空间）。当一个程序成为了进程，操作系统为其在内存中分配资源，来存放机器指令和数据，并为其映射了虚拟的内存地址，从而实现进程之间的相互独立性，这也是为什么一个进程无法直接通过内存地址访问另一个进程的数据，或者说同样一个内存地址对于不同进程，（极大）可能存储着不同的数据。</p>
<p>但是想实现操作其他进程的内存也不是毫无办法，Windows提供了一系列相关API，本文中使用了VirtualAllocEx，该函数可以在某一进程中分配内存，若分配成功，我们可以使用另一函数WriteProcessMemory来修改这块内存空间的内容。</p>
<h3 id="DLL为何物"><a href="#DLL为何物" class="headerlink" title="DLL为何物"></a>DLL为何物</h3><p>本文作为DLL注入的第一章，那就不得不先介绍一下DLL了。DLL为动态链接库的英文缩写，“库”字，顾名思义，我们可以在里面存放一些东西，也就是指令和数据；“链接”是一个与编译原理有关的名词，因为DLL主要存放函数，而程序运行可以通过链接信息，找到某一函数的所在地址从而调用该函数；“动态”表示DLL是在程序运行时才加载的（静态链接库在程序编译时进行加载，程序运行时就无需加载静态链接库了）。由此我们可以总结，DLL是一个在程序运行时，可以由程序自己加载的函数、数据库。另外需要补充很重要的一点，操作系统中一个动态链接库可能有很多进程来使用，但是操作系统在内存中只会保留一份这个动态链接库供所有进程使用。</p>
<h3 id="DLL注入？"><a href="#DLL注入？" class="headerlink" title="DLL注入？"></a>DLL注入？</h3><p>既然我们知道了DLL可以由程序自己加载，那么就不难想到，如果我们利用CreateRemoteThread函数在另一个进程中创建一个线程，让这个线程通过某种方式加载DLL到进程中，那么我们是不是就可以将我们写好的DLL“挂”到任意一个进程中了呢？</p>
<p>没错，这也就是这种DLL注入方法的思想。CreateRemoteThread注入DLL的核心函数就是CreateRemoteThread，这个函数可以用来在其他进程中创建线程，（在上一篇文章《远程线程『 RemoteThread 』》也提到了，大家可以看一下），我们将线程执行的函数就设为LoadLibraryW，将参数设为DLL在文件系统中的绝对地址，线程启动后便可成功注入了。在这里，DLL在文件系统中的绝对地址以宽字符串类型（LPCWSTR）来存储，我们利用VirtualAllocEx、WriteProcessMemory来在目标进程中分配空间并写入字符串。还有一点要注意，虽然操作系统为每个进程映射了不同的虚拟内存地址，但是每个进程的kernel32.dll的映像起始地址都是相同的，所以LoadLibraryW函数在每个进程中的地址也都一样。</p>
<h2 id="附：示例DLL源代码"><a href="#附：示例DLL源代码" class="headerlink" title="附：示例DLL源代码"></a>附：示例DLL源代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : Defines the entry point for the DLL application.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;wchar.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态链接库每次被加载、卸载都会执行DllMain</span></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HMODULE hModule,</span></span></span><br><span class="line"><span class="params"><span class="function">                       DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="params"><span class="function">                       LPVOID lpReserved</span></span></span><br><span class="line"><span class="params"><span class="function">                     )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in"><span class="keyword">switch</span></span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">        <span class="built_in">wprintf_s</span>(<span class="string">L&quot;DLL_PROCESS_ATTACH\n&quot;</span>);</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">        <span class="built_in">wprintf_s</span>(<span class="string">L&quot;DLL_THREAD_ATTACH\n&quot;</span>);</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">        <span class="built_in">wprintf_s</span>(<span class="string">L&quot;DLL_THREAD_DETACH\n&quot;</span>);</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="built_in">wprintf_s</span>(<span class="string">L&quot;DLL_PROCESS_DETACH\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] Gality369/Process-Injection: 汇总了目前可以找到的所有的进程注入的方式，完成了x86/x64下的测试，不断更新中 <a target="_blank" rel="noopener" href="https://github.com/Gality369/Process-Injection">https://github.com/Gality369/Process-Injection</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://zsy-arch.github.io/2021/08/19/just-inject-%E7%AC%AC%E4%B8%80%E5%A4%A9-CreateRemoteThreadInject/" data-id="cku8gvn3h000htkv4b8k0aqzw" data-title="just_inject 第一天: CreateRemoteThreadInject" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-远程线程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/08/19/%E8%BF%9C%E7%A8%8B%E7%BA%BF%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2021-08-19T08:37:28.000Z" itemprop="datePublished">2021-08-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/08/19/%E8%BF%9C%E7%A8%8B%E7%BA%BF%E7%A8%8B/">远程线程（RemoteThread）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="回顾线程"><a href="#回顾线程" class="headerlink" title="回顾线程"></a>回顾线程</h2><p>程序开始运行时，操作系统就创建了这个程序的进程。一个进程中有多个线程，一个线程就是这个进程正在执行的一个任务。比如main函数就在一个线程中执行。</p>
<h2 id="远程线程注入"><a href="#远程线程注入" class="headerlink" title="远程线程注入"></a>远程线程注入</h2><p>首先，这篇文章不是讲远程线程DLL注入（但可以说是为其打基础）。在初学Windows API时，我们学到过函数CreateThread，用来在当前进程中创建一个线程。在这里，又有了一个新的函数——CreateRemoteThread，这两个函数不光名字像，参数列表也很相似（后者只是增加了一个目标进程句柄）。</p>
<p>要进行远程线程注入，我们首先要有一个目标，这里就是inject_me.cpp所生成的程序。该程序在不受外界影响的情况下会无限循环下去。</p>
<p><strong>inject_me.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">DWORD dwProcessId = <span class="number">0</span>;</span><br><span class="line">DWORD dwThreadId = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">TestFunc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;You injected me.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">1000</span> * <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadFunc</span><span class="params">(LPVOID lpParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; std::hex &lt;&lt; ((DWORD *)&amp;TestFunc) &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;PID: &quot;</span> &lt;&lt; dwProcessId &lt;&lt; <span class="string">&quot; TID: &quot;</span> &lt;&lt; dwThreadId &lt;&lt; <span class="string">&quot; inject me.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">1000</span> * <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    dwProcessId = <span class="built_in">GetCurrentProcessId</span>();</span><br><span class="line"></span><br><span class="line">    HANDLE hThread = <span class="built_in">CreateThread</span>(</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        (LPTHREAD_START_ROUTINE)ThreadFunc,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        &amp;dwThreadId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hThread != INVALID_HANDLE_VALUE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">WaitForSingleObject</span>(hThread, INFINITE);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">        hThread = INVALID_HANDLE_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来就是最核心的注入程序了。首先最重要的一点就是：进行远程线程注入时，线程执行的函数或者说线程所执行的机器码应该在目标进程（inject_me.exe）中已存在，本文中线程执行的函数就是TestFunc，而Inject函数的参数（目标进程ID，线程函数TestFunc的地址）需要从inject_me.exe中获取。</p>
<p><strong>inject.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Inject</span><span class="params">(DWORD dwTargetProcessId, DWORD dwFuncAddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE hTargetProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, dwTargetProcessId);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hTargetProcess == <span class="literal">NULL</span> || hTargetProcess == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;OpenProcess failed.\n&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	DWORD dwThreadId = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	HANDLE hRemoteThread = <span class="built_in">CreateRemoteThread</span>(hTargetProcess,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		(LPTHREAD_START_ROUTINE)dwFuncAddr,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		&amp;dwThreadId);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hRemoteThread == <span class="literal">NULL</span> || hRemoteThread == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;CreateRemoteThread failed.\n&quot;</span>;</span><br><span class="line">		<span class="built_in">CloseHandle</span>(hTargetProcess);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">WaitForSingleObject</span>(hRemoteThread, INFINITE);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hRemoteThread);</span><br><span class="line">	hRemoteThread = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">Inject</span>(<span class="number">0x78bc</span>, <span class="number">0x00234539</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h2><p>首先运行inject_me.exe，程序会输出<code>00234539</code>为TestFunc的地址，<code>78bc</code>为PID以及TID<code>7704</code>。当我们开始运行inject.exe开始对目标进程inject_me.exe注入，正常情况下目标进程将会新建一个进程，执行TestFunc函数，并输出：<code>You injected me.</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">00234539</span><br><span class="line">PID: 78bc TID: 7704 inject me.</span><br><span class="line">00234539</span><br><span class="line">PID: 78bc TID: 7704 inject me.</span><br><span class="line">00234539</span><br><span class="line">PID: 78bc TID: 7704 inject me.</span><br><span class="line">--------------开始注入------------------</span><br><span class="line">00234539</span><br><span class="line">PID: 78bc TID: 7704 inject me.</span><br><span class="line">You injected me.</span><br><span class="line">00234539</span><br><span class="line">PID: 78bc TID: 7704 inject me.</span><br><span class="line">You injected me.</span><br><span class="line">00234539</span><br><span class="line">PID: 78bc TID: 7704 inject me.</span><br><span class="line">You injected me.</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://zsy-arch.github.io/2021/08/19/%E8%BF%9C%E7%A8%8B%E7%BA%BF%E7%A8%8B/" data-id="cku8gvn3j000jtkv4akf2ay88" data-title="远程线程（RemoteThread）" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">weiter &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/10/05/tasteless-ctf-2021-rev-PVM/">tasteless_ctf_2021 [rev] PVM</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">编译原理学习笔记</a>
          </li>
        
          <li>
            <a href="/2021/10/01/CSAPP-1-%E5%8E%9F%E7%A0%81%E3%80%81%E5%8F%8D%E7%A0%81%E3%80%81%E8%A1%A5%E7%A0%81%E3%80%81IEEE-754/">CSAPP 1 - 原码、反码、补码、IEEE 754 实战</a>
          </li>
        
          <li>
            <a href="/2021/09/30/Cross-compile-and-QEMU/">Cross compile and QEMU</a>
          </li>
        
          <li>
            <a href="/2021/08/28/C-argument-dependent-name-lookup/">C++ argument-dependent name lookup</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 zsy<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>